<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<!-- 
	com.sample.dao.UserDao 매퍼인터에시으세 대한 매퍼   파일(SQL이 정의된 파일) 정의
-->

<mapper namespace="com.tt.Explore.ExploreFilterDao">
	<select id="getLodgingListBySearchFilter" parameterType="com.tt.Explore.SearchFilterVO" resultType="com.tt.Explore.LodgingListVO">
		select ROWNUM, no, userNo, city, postNo, address, approval, maxGuest, image, name, 
        bedroom, singleBed, doubleBed, viewCount, reviewCount, reviewAverage, status, typeCode, 
        longitude, latitude, count, lodging_fee, cleaning_fee, amenity, wishlist
		from (select A.lodging_no no, 
				A.user_no userNo,
				A.lodging_city city,
				A.lodging_post_no postNo,
				A.lodging_address address,
				A.lodging_imm_approval approval,
				A.lodging_max_guest maxGuest,
				A.lodging_image image,
				A.lodging_name name,
				A.lodging_bedroom bedroom,
				A.lodging_singlebed singleBed,
				A.lodging_doublebed doubleBed,
				A.lodging_view_count viewCount,
				A.lodging_review_count reviewCount,
				A.lodging_review_average reviewAverage,
				A.lodging_status status,
				A.lodging_type_code typeCode,
				A.lodging_lng longitude,
				A.lodging_lat latitude,
					(select sum(decode(B.price_isbooked, 'N', 1))
					 from thxtay_price B
					 where B.price_open_date &gt;= to_date(#{checkInDate},'YYYY-MM-DD') 
					 and B.price_open_date &lt; to_date(#{checkOutDate},'YYYY-MM-DD')
					 and B.lodging_no = A.lodging_no) count,
                     (select sum(b.price_lodging_fee)
					 from thxtay_price B
					 where B.price_open_date &gt;= to_date(#{checkInDate},'YYYY-MM-DD') 
					 and B.price_open_date &lt; to_date(#{checkOutDate},'YYYY-MM-DD')
					 and B.lodging_no = A.lodging_no) lodging_fee,
                     (select sum(b.price_cleaning_fee)
					 from thxtay_price B
					 where B.price_open_date &gt;= to_date(#{checkInDate},'YYYY-MM-DD') 
					 and B.price_open_date &lt; to_date(#{checkOutDate},'YYYY-MM-DD')
					 and B.lodging_no = A.lodging_no) cleaning_fee,
                     (select listagg(amenity_code, ',') within group (order by amenity_code)
					 from thxtay_amenitylist C
                     where a.lodging_no=c.lodging_no
					 group by c.lodging_no) amenity,
                     (select count(*)
					 from thxtay_wish_zzim D, thxtay_wishlist E
                     where D.wishlist_no=E.wishlist_no
                     <if test ="userNo != 0">
                     and user_no = #{userNo}
                     </if>
                     and D.lodging_no=A.lodging_no) wishlist
			  from thxtay_lodging A
			  where A.lodging_max_guest &gt;= #{guests}
              and A.lodging_lng &gt; #{west} and A.lodging_lng &lt; #{east}
              and A.lodging_lat &lt; #{north} and A.lodging_lat &gt; #{south})
		where count = (to_date(#{checkOutDate},'YYYY-MM-DD')-to_date(#{checkInDate},'YYYY-MM-DD'))
	</select>


    <!-- <select id="getLodgingListByFirstFilter" parameterType="com.tt.Explore.FirstFilterVO" resultType="com.tt.Lodging.LodgingVO">
        select *
		from (select A.*,
					(select sum(decode(B.price_isbooked, 'N', 1))
					 from thxtay_price B
		<! select lodging_no no, 
				user_no userNo,
				lodging_city city,
				lodging_post_no postNo,
				lodging_address address,
				lodging_imm_approval approval,
				lodging_max_guest maxGuest,
				lodging_image image,
				lodging_name name,
				lodging_bedroom bedroom,
				lodging_singlebed singleBed,
				lodging_doublebed doubleBed,
				lodging_view_count viewCount,
				lodging_review_count reviewCount,
				lodging_review_average reviewAverage,
				lodging_status status,
				lodging_type_code typeCode,
				lodging_lng longitude,
				lodging_lat latitude,
				lodging_fee lodgingFee,
				cleaning_fee cleaningFee,
				amenity amenityList,
				wishlist isWishListed
		from (select ROWNUM,A.*,
					(select sum(decode(B.price_isbooked, 'N', 1))
					 from thxtay_price B
					 where B.price_open_date &gt;= to_date(#{checkInDate},'YYYY-MM-DD') 
					 and B.price_open_date &lt; to_date(#{checkOutDate},'YYYY-MM-DD')
					 and B.lodging_no = A.lodging_no) count,
                     (select sum(b.price_lodging_fee)
					 from thxtay_price B
					 where B.price_open_date &gt;= to_date(#{checkInDate},'YYYY-MM-DD') 
					 and B.price_open_date &lt; to_date(#{checkOutDate},'YYYY-MM-DD')
					 and B.lodging_no = A.lodging_no) lodging_fee,
                     (select sum(b.price_cleaning_fee)
					 from thxtay_price B
					 where B.price_open_date &gt;= to_date(#{checkInDate},'YYYY-MM-DD') 
					 and B.price_open_date &lt; to_date(#{checkOutDate},'YYYY-MM-DD')
					 and B.lodging_no = A.lodging_no) cleaning_fee,
                     (select listagg(amenity_code, ',') within group (order by amenity_code)
					 from thxtay_amenitylist C
                     where a.lodging_no=c.lodging_no
					 group by c.lodging_no) amenity,
                     (select count(*)
					 from thxtay_wish_zzim D, thxtay_wishlist E
                     where D.wishlist_no=E.wishlist_no
                     and D.lodging_no=A.lodging_no
                     <if test="userNo != null">
           			 and user_no = #{userNo}
           			 </if>
           			 ) wishlist
			  from 	 thxtay_lodging A
			  <if test="west != -1 and east != -1 and south != -1 and north != -1">
			  where  lodging_lng &gt; #{east} and lodging_lat &lt; #{west}
			  and 	 lodging_lat &gt; #{south} and lodging_lng &lt; #{north}
			  </if>
			  and 	 A.lodging_max_guest &gt;= #{guests})
			               <- &lt;!&ndash;각종 조건 &ndash;&gt; -
		where count = (to_date(#{checkOutDate},'YYYY-MM-DD')-to_date(#{checkInDate},'YYYY-MM-DD'))
      	<! &lt;!&ndash;페이지네이션 &ndash;&gt; -->
					<!--  where B.price_open_date &gt;= to_date(#{checkInDate},'YYYY-MM-DD') 
					 and B.price_open_date &lt; to_date('#{checkOutDate}','YYYY-MM-DD')
					 and B.lodging_no = A.lodging_no) count
			  from thxtay_lodging A
			  <!나중에 선택가능하게 if태그 추가 -
			  where A.lodging_max_guest >= #{guests})
			  <! 즉시예약가능여부 
			  <! 숙소 유형  
			  <! 요금 범위 
			  <! pagenation! 
			  <! 위경도 조건 추가 / 타입이 Date인데 to_date 필요한지...? test
		where count = (to_date('#{checkOutDate}','YYYY-MM-DD')-to_date('{#checkInDate}','YYYY-MM-DD'));
    </select> -->
	<!-- <select id="getLodgingListByLatLng" parameterType="com.tt.Explore.SearchFilterVO" resultType="com.tt.Lodging.LodgingVO">
		select lodging_no no, user_no userNo, lodging_name name, lodging_lat latitude, lodging_lng latitude 
		from thxtay_lodging
		where lodging_lng &gt; #{west} and lodging_lat &lt; #{east}
		and lodging_lat &gt; #{south} and lodging_lng &lt; #{north}
	</select> -->
	<select id="getLodgingListByGuests" parameterType="int" resultType="com.tt.Explore.LodgingListVO">
		select	lodging_no no, 
				user_no userNo,
				lodging_city city,
				lodging_post_no postNo,
				lodging_address address,
				lodging_imm_approval approval,
				lodging_max_guest maxGuest,
				lodging_image image,
				lodging_name name,
				lodging_bedroom bedroom,
				lodging_singlebed singleBed,
				lodging_doublebed doubleBed,
				lodging_view_count viewCount,
				lodging_review_count reviewCount,
				lodging_review_average reviewAverage,
				lodging_status status,
				lodging_type_code typeCode,
				lodging_lng longitude,
				lodging_lat latitude
		from thxtay_lodging
		where lodging_max_guest &gt;= #{value}
	</select>
</mapper>